<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EZ Harbor Pool Test</title>
</head>
<body>
  <h1>Enter Pool Test Values</h1>
  <form id="numericForm">
    <!-- Date Field with formatted display moved to the top -->
    <label for="testDate">Date:</label>
    <input type="text" id="testDate" name="testDate" placeholder="dd-mmm-yy" required>
    <br><br>

    <label for="chlorine">Chlorine:</label>
    <input type="number" id="chlorine" name="chlorine" step="0.1" required><br><br>

    <label for="ph">Ph:</label>
    <input type="number" id="ph" name="ph" step="0.1" required><br><br>

    <label for="acidDemand">Acid Demand (drops):</label>
    <input type="number" id="acidDemand" name="acidDemand" step="1"><br><br>

    <label for="totalAlkalinity">Total Alkalinity (drops):</label>
    <input type="number" id="totalAlkalinity" name="totalAlkalinity" step="1"><br><br>

    <button type="submit">Submit</button>
  </form>

  <!-- Div to show the server response -->
  <div id="responseMessage" style="margin-top:20px; font-weight:bold;"></div>

  <script>
    function formatDate(date) {
      if (!(date instanceof Date) || isNaN(date.getTime())) {
          console.error("Invalid Date object passed to formatDate:", date);
          return "--";
      }

      const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      const day = String(date.getDate()).padStart(2, '0');
      const monthIndex = date.getMonth();
      const month = months[monthIndex];
      const year = String(date.getFullYear()).slice(-2);

      console.log("Date parts — Day:", day, "Month index:", monthIndex, "Month name:", month, "Year:", year);

      if (!month) {
        console.error("Month index out of range or undefined:", monthIndex);
        return "--";
      }

      //const formatted = day + '-' + month + '-' + year;
      const formatted = [day, month, year].join('-');
      console.log("Formatted date is:", formatted);
      return formatted;
    }


    window.addEventListener('DOMContentLoaded', () => {
      const testDateField = document.getElementById('testDate');
      console.log("testDate field found:", !!testDateField);

      if (testDateField) {
        console.log("Current value of testDate field:", testDateField.value);
        if (!testDateField.value) {
          const today = formatDate(new Date());
          testDateField.value = today;
          console.log("Date field was empty — setting value to:", today);
        } else {
          console.log("Date field already had a value, so it was left unchanged.");
        }
      } else {
        console.warn("No element found with id 'testDate'");
      }
    });

    document.getElementById('testDate').value = formatDate(new Date());

    document.getElementById("numericForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const dateInput = document.getElementById("testDate").value;

      const monthRegex = /\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i;

      // Test cases
      console.log(monthRegex.test("Jan"));         // true
      console.log(monthRegex.test("JAN"));         // true
      console.log(monthRegex.test("jan"));         // true
      console.log(monthRegex.test("JaN"));         // true
      console.log(monthRegex.test("January"));     // false (not a 3-letter abbreviation)
      console.log(monthRegex.test("05-Jan-25"));   // true (contains "Jan")
      console.log(monthRegex.test("05-January-25"));// false
      console.log(monthRegex.test("abc"));         // false

      const dateRegex = /^(\d{2})-([A-Za-z]{3})-(\d{2})$/i;
      const monthsMap = {
        "jan": 0, "feb": 1, "mar": 2, "apr": 3, "may": 4, "jun": 5,
        "jul": 6, "aug": 7, "sep": 8, "oct": 9, "nov": 10, "dec": 11
      };

      const match = dateInput.match(dateRegex);
      if (!match || monthsMap[match[2].toLowerCase()] === undefined) {
        alert("Invalid date format. Please enter as dd-mmm-yy (e.g., 05-Apr-25).");
        return;
      }

      const day = match[1];
      const month = monthsMap[match[2].toLowerCase()];
      const year = `20${match[3]}`;

      const isoDate = new Date(year, month, day).toISOString().split('T')[0];

      const chlorine = parseFloat(document.getElementById("chlorine").value);
      const ph = parseFloat(document.getElementById("ph").value);
      const acidDemandInput = document.getElementById("acidDemand").value;
      const totalAlkalinityInput = document.getElementById("totalAlkalinity").value;

      const data = { chlorine, ph, testDate: isoDate };

      if (acidDemandInput !== "") data.acidDemand = parseInt(acidDemandInput);
      if (totalAlkalinityInput !== "") data.totalAlkalinity = parseInt(totalAlkalinityInput);

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 4000);

      fetch('http://${SERVER_IP}:${SERVER_PORT}/webhook', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
        mode: "cors",
        signal: controller.signal
      })
      .then(response => response.json())
      .then(data => {
        clearTimeout(timeoutId);
        document.getElementById("responseMessage").innerText = "Success! Server replied: " + JSON.stringify(data);
        document.getElementById("numericForm").reset();
        document.getElementById('testDate').value = formatDate(new Date());
      })
      .catch(error => {
        clearTimeout(timeoutId);
        console.error('Error:', error);
        let errorMessage = error.name === 'AbortError' ? "Request timed out after 4 seconds." : error;
        document.getElementById("responseMessage").innerText = "An error occurred: " + errorMessage;
      });
    });
  </script>
</body>
</html>
